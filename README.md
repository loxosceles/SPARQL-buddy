# SPARQL-buddy
## Command line tool for querying SPARQL endpoints

### Setup
Make sure the script is on your PYTHONPATH. From iPython:

    import sparql_buddy as sb

Now your good to go. For convenience the script creates a first SPARQL query object.
This object uses http://dbpedia.org as default endpoint. To make it easier to access
I usually rename it:

    sq = sb.sq


### Usage
#### Accessing default configuration
This version of SPARQL-Buddy is meant to be imported into iPython, at least this is
how I like to use it. Nothing will stop you from building your own GUI or web
interface if you feel more comfortable with that.
This quick introduction assumes that you will be following the examples using
iPython.

Check the default url and set a different one:

    sq.url    # 'http://dbpedia.org/sparql'
    sq.url = 'http://semantic.ckan.net/sparql/'
    sq.url    # 'http://semantic.ckan.net/sparql/'
You can change every default setting in the same way.  

Check the default query file folder:

    sq.query_file_folder  # './queries'

The abbreviated prefixes which map to namespaces in your queries are saved in the
prefix file. You don't have to include the PREFIX section into your queries, only the
abbreviated prefixes in the **first** line of your query. Look at the query section
for an example (inline query).\
The default prefix configuration file:
  
    sq.prefix_file  # './prefixes.csv'

To see your prefix-namespace mappings (loaded into memory at startup):
  
    sq.prefix_mapping_dict

    # {'owl': '<http://www.w3.org/2002/07/owl#>',
    #  'dbo': '<http://dbpedia.org/ontology/>',
    #  'dbp': '<http://dbpedia.org/property>',
    #  'dbr': '<http://dbpedia.org/resource/>',
    #  'dc': '<http://purl.org/dc/elemental/1.1/>',
    #  ...


List your saved queries (inside the query file folder):

    sq.query_files()

    # {0: 'movies',
    #  1: 'russian_cities',
    #  2: 'avail_graphs',
    #  3: 'landlocked_countries',
    #  4: 'person_1',
    #  ...

#### Running queries

There are three ways of running a query:
1. Writing your query from scratch (Inline)
2. Referencing a saved query (inside the query folder) by number
3. Referencing a saved query by name

##### 1. Inline query:
  
    sq.run_query("""dbr dbo foaf
      SELECT ?name ?birth ?death ?person 
        WHERE {      
            ?person dbo:birthPlace dbr:Berlin .      
            ?person dbo:birthDate ?birth .      
            ?person foaf:name ?name .      
            ?person dbo:deathDate ?death .      
            FILTER (?birth < "1900-01-01"^^xsd:date) . 
        } ORDER BY ?name
    """)

Note that the query is surrounded by triple quotes which in Python is a multiple line
string literal. Also, it is important to define prefixes. With inline queries this
has to be done on the first line using the abbreviations defined in the `prefix.csv`
file.

##### 2. By number (number generated by output of `query_files()`:

    sq.run_query(1)

##### 3. By name (name of any of the files in the `query_file_folder`)
  
    sq.run_query('landlocked_countries')

#### Working with queries
You can retrieve the latest query object which holds the following information:
- Query environment (url, prefix file path, query file folder path, ... )
- Query
- Response

Since every query which has been run in a particular session is saved as an object
with that information attached you can now run different methods on it. It is
convenient to assign the latest query object for instance if you want to refine a
query:

    a =  sq.latest_qobj()  # same as sq.latest_qobj(1)

This method take an integer as argument, which will let you access not only the
latest but also earlier queries by index. So `2`will get the penultimate query, `3`
the antepenultimate, and so forth.

Now with that new variable you can extract the information:

    a.print_query()        # returns query, prefixes translated, pretty printed JSON
    a.print_response()     # returns response, pretty printed JSON
    a.print_raw_response() # returns response, single string, no spaces

It is also possible to access the query and response directly, skipping the pretty
printing:

    a.query      # returns query, prefixes translated
    a.rquery     # returns query, prefixes abbreviated
    a.response   # returns response

Especially the `rquery` is useful if you want to reuse your previous query and save a
modified version of it. This way you don't introduce more formatting characters into
the new versions.

In order to see only the variables of the result without any clutter you can filter
them:

    a.filter_attributes()
      
    # person: http://dbpedia.org/resource/Annot_(artist)
    # name: "Annot" (Annot Jacobi)
    # death: 1981-10-20
    # birth: 1894-12-27

    # person: http://dbpedia.org/resource/Adelbert_Theodor_Wangemann
    # name: A. Theo E. Wangemann
    # death: 1906
    # birth: 1855-02-13

    # person: http://dbpedia.org/resource/Lina_Abarbanell
    # name: Abarbanell, Lina
    # death: 1963-01-06
    # birth: 1879-01-03
    # ...

#### Keyword search

Keyword search has tree modes:
  1. Extended search
  2. Strict search
  3. Quick search

##### 1. Extended search (default)
    
    sq.keyword_search("Mahatma Gandhi")

    # {
    #   "name": {
    #       "type": "literal",
    #       "value": "Statue of Mahatma Gandhi, Gandhi Maidan",
    #       "xml:lang": "en"
    #   },
    #   "place": {
    #       "type": "uri",
    #       "value": "http://dbpedia.org/resource/Statue_of_Mahatma_Gandhi,_Gandhi_Maidan"
    #   }
    # }, {... output omitted ... },
    # {
    #   "name": {
    #       "type": "literal",
    #       "value": "Mahatma Gandhi",
    #       "xml:lang": "en"
    #   },
    #   "person": {
    #       "type": "uri",
    #       "value": "http://dbpedia.org/resource/Mahatma_Gandhi"
    #   }
    # },
    # {
    #   "name": {
    #       "type": "literal",
    #       "value": "Mahatma Gandhi Institute of Technology",
    #       "xml:lang": "en"
    #   },
    #   "organization": {
    #       "type": "uri",
    #       "value": "http://dbpedia.org/resource/Mahatma_Gandhi_Institute_of_Technology"
    # }
    # }, {... output omitted ... }], ...

As you can see from this rather long ouput example, the extended search will find any
related resource to the search string. Mahatma Gandhi was obviously a person but
other resources can be named after him for instance. The category of the "thing" (a
super category) will be show as well. Currently there are the following categories:
- Place
- Person
- Action
- Organization
- Event

Of course these categories could extended easily to embrace other types of entities.

##### 2. Strict search
The strict search will only look for the given search term. The only modification it
does does equally to the extended search is the replacing of one blank space with an
underscore.
